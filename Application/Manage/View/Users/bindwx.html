
<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>绑定账号</title>
    <link rel="stylesheet" href="__CSS__/weui/weui.css"/>
    <link rel="stylesheet" href="__CSS__/weui/example.css"/>
    <script src="__JS__/jquery.min.js"></script>
</head>
<body>
<if condition="$type eq 1">
  <form action="" method="post" enctype="multipart/form-data" id="bdaccount">
  <div class="hd" style="padding:10px 0">
      <h1 class="page_title" style="font-size: 22px; color: #1d599f">{$configs.siteName}账号绑定</h1>
  </div>
    <div class="weui_cells weui_cells_form">
        <div class="weui_cell">
            <div class="weui_cell_hd"><label class="weui_label">{$configs.siteName}账号</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="text" name="loginName" placeholder="请输入登陆账号">
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd"><label class="weui_label">{$configs.siteName}密码</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="password" name="loginPwd" placeholder="请输入登陆密码">
            </div>
        </div>
    </div>
    <div class="weui_cells weui_cells_radio">
            <label class="weui_cell weui_check_label" for="x11">
                <div class="weui_cell_bd weui_cell_primary">
                    <p>商户账号</p>
                </div>
                <div class="weui_cell_ft">
                    <input type="radio" class="weui_check" name="type" value="1" id="x11" checked="checked">
                    <span class="weui_icon_checked"></span>
                </div>
            </label>
            <label class="weui_cell weui_check_label" for="x12">

                <div class="weui_cell_bd weui_cell_primary">
                    <p>员工账号</p>
                </div>
                <div class="weui_cell_ft">
                    <input type="radio" name="type" value="2" class="weui_check" id="x12">
                    <span class="weui_icon_checked"></span>
                </div>
            </label>
    </div>
    <div class="weui_btn_area">
      <a class="weui_btn" href="javascript:" style="background: #1d599f" id="bindwx">绑定账号</a>
    </div>
    <input type="hidden" value="af34kie#j22#jfi19"  name="code">
    <input type="hidden" value="{$token}" name="token">
    <input type="hidden" value="{$wxinfo.openid}" name="openid">
    <input type="hidden" value="{$wxinfo.nickname}" name="nickname">
    <input type="hidden" value="{$wxinfo.sex}" name="sex">
    <input type="hidden" value="{$wxinfo.language}" name="language">
    <input type="hidden" value="{$wxinfo.city}" name="city">
    <input type="hidden" value="{$wxinfo.province}" name="province">
    <input type="hidden" value="{$wxinfo.country}" name="country">
    <input type="hidden" value="{$wxinfo.headimgurl}" name="headimgurl">
    <input type="hidden" value="{$wxinfo.subscribe_time}" name="subscribe_time">
    <input type="hidden" value="{$wxinfo.remark}" name="remark">
    <input type="hidden" value="{$wxinfo.groupid}" name="groupid">
  </form>
<else />
  <div class="msg">
    <div class="weui_msg">
        <div class="weui_icon_area"><i class="weui_icon_msg weui_icon_warn"></i></div>
        <div class="weui_text_area">
            <h2 class="weui_msg_title">抱歉！</h2>
            <p class="weui_msg_desc">{$msg}</p>
        </div>
        <div class="weui_opr_area">
            <p class="weui_btn_area">
                <a href="javascript:;" onclick="WeixinJSBridge.call('closeWindow');" class="weui_btn weui_btn_primary">确定</a>
            </p>
        </div>
    </div>
  </div>
</if>

<div id="success" class="msg" style="display: none;">
  <div class="weui_msg">
      <div class="weui_icon_area"><i class="weui_icon_success weui_icon_msg"></i></div>
      <div class="weui_text_area">
          <h2 class="weui_msg_title">账号绑定成功</h2>
          <p class="weui_msg_desc">请勿取消关注，否则无法接收系统通知和收银通知</p>
      </div>
      <div class="weui_opr_area">
          <p class="weui_btn_area">
              <a href="javascript:;" onclick="WeixinJSBridge.call('closeWindow');" class="weui_btn weui_btn_primary">确定</a>
          </p>
      </div>
  </div>
</div>

<div class="weui_dialog_alert" id="tip" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">抱歉</strong></div>
        <div class="weui_dialog_bd"></div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div id="loading" class="weui_loading_toast" style="display: none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p class="weui_toast_content">数据提交中</p>
    </div>
</div>

<script src="__JS__/weui/zepto.min.js"></script>
<script src="__JS__/weui/router.min.js"></script>
<script>
  $('#bindwx').click(function(){
    var bdwxData = $(this).parents('form').serialize();
    bdwxData = htmlToArray(bdwxData);
    if(bdwxData['loginName'] == "" || bdwxData['loginPwd'] == ""){
        $('.weui_dialog_bd').html("账号或密码不能为空！");
        $('#tip').show().on('click', '.weui_btn_dialog', function () {
            $('#tip').off('click').hide();
        });
    }else{
        $('#loading').show();
        $.post('{:U("Manage/Users/saveBindwx")}',{data: bdwxData},function(result){
          $('#loading').hide();
          if(result.status == 1){
            $('#bdaccount').hide();
            $('#success').show();
          }else if(result.status == -1){
            $('.weui_dialog_bd').html("账号或密码错误！");
            $('#tip').show().on('click', '.weui_btn_dialog', function () {
                  $('#tip').off('click').hide();
            });
          }else if(result.status == -2){
            $('.weui_dialog_bd').html("该账号已绑定过微信用户！");
            $('#tip').show().on('click', '.weui_btn_dialog', function () {
                  $('#tip').off('click').hide();
            });
          }else{
            $('.weui_dialog_bd').html("绑定失败,请稍后再试！");
            $('#tip').show().on('click', '.weui_btn_dialog', function () {
                  $('#tip').off('click').hide();
            });
          }
        },'json');
    }
  });

  function htmlToArray(data){
    data = data.split('&');
    var info = {};
    $.each(data,function(k,v){
      v = v.replace('%5D','').split('=');
      var s = v[0].split('%5B');
      typeof(info[s[0]]) == 'undefined' && (info[s[0]] = {}),info[s[0]] = v[1];
    });
    return info;
  }
</script>
</body>
</html>
