<extend name="Public/base"/>

<block name="title">支付配置</block>

<block name="levels"><li><a href="{:U("SX/Index/index")}">后台首页</a></li><li>系统配置</li></block>

<block name="body">
            <div class="row">
            	<div class="col-lg-6">
            	    <div class="ibox float-e-margins">
            	        <div class="ibox-title clearfix">
            	            <h5 style="margin: 10px 0 0px;">支付配置</h5>
            	        </div>
            	        <div class="ibox-content">
							<div class="alert alert-warning">
                                                            请务必配置好您的银行渠道参数，线上系统运行时请勿随意改动此参数，避免出现运营事故。                               <!--1、请配置一个有特约商户管理功能的商户号相关微信支付信息，不然服务商模式不可用。-->
                               <br>
                               <!--2、发送红包和代收商户提现使用的是服务商配置，请保持服务商的可用余额足够使用。-->
                               <br>
							  <!--<strong style="color:red;">3、特别提醒：一旦配置好，请勿再改换配置。如果改换了配置，那么在原来的配置上所付款将不能退款，所发的卡券不能核销等等</strong>-->
                            </div>
							<table class="table table-striped">
            	                <tr>
            	                    <td><img style="margin-left: 15px" src="__IMG__/pay_icon/guangda.png"></td>
            	                    <td style="padding-top: 14px;">银行通道</td>
            	                    <td><button class="btn btn-info " type="button" data-toggle="modal" data-target="#gdSetting"><i class="fa fa-paste"></i>配置信息</button></td>
            	                    <td></td>
            	                </tr>
<!--            	                <tr>
            	                    <td><img style="margin-left: 15px" src="__IMG__/pay_icon/weixin.png"></td>
            	                    <td style="padding-top: 14px;">微信支付</td>
            	                    <td id="wxapiinfo1"><button class="btn btn-info " type="button" checked="checked" data-toggle="modal" data-target="#weixinSetting"><i class="fa fa-paste"></i>服务商配置</button></td>
            	                    <td id="wxapiinfo1"><button class="btn btn-info " type="button" checked="checked" data-toggle="modal" data-target="#weixinSetting2"><i class="fa fa-paste"></i>充值和代收配置</button></td>
									 <td id="wxapiinfo2"></td> 
            	                </tr>
								<tr>
            	                    <td><img style="margin-left: 15px" src="__IMG__/pay_icon/alipay.png"></td>
            	                    <td style="padding-top: 14px;">支付宝支付</td>
            	                    <td><button class="btn btn-info " type="button" data-toggle="modal" data-target="#alipaySetting"><i class="fa fa-paste"></i>配置信息</button></td>
									<td></td>
            	                </tr>-->
            	            </table>
            	        </div>
            	    </div>
            	</div>
            </div>
</block>

<block name="top">
    <link href="__CSS__/plugins/custom.css" rel="stylesheet">
	<link href="__CSS__/plugins/basic.css" rel="stylesheet">
    <link href="__CSS__/plugins/dropzone.css" rel="stylesheet">
    <script src="__JS__/plugins/icheck.min.js"></script>
    <script src="__JS__/plugins/dropzone.js"></script>
	<style>
		.ibox-title h5 {
  			margin: 10px 0 0px;
		}
		select.input-sm {
  			height: 35px;
  			line-height: 35px;
		}
		.float-e-margins .btn-info{
			margin-bottom:0px;
			padding:3px;
		}
		.fa-paste{
			margin-right:7px;
			padding: 0px;
		}
		.dz-preview{
			display:none;
		}
		.red{color:red;}
	</style>
</block>

<block name="bottom">
	<div class="modal inmodal" tabindex="-1" role="dialog" aria-hidden="true" id="weixinSetting">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInRight">
				<form action="" method="post" enctype="multipart/form-data">
				<div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">微信支付 服务商配置</h4>
                </div>
				<div class="modal-body">
					<div class="setting_rows">
						<div id="new_wxpay_box" class="wxpay_box">
							
							<div class="form-group">
								<label>Appid</label>
								<input type="text" placeholder="Appid" value="{$configs['wx_appId']}" name="wx_appId" class="form-control">
							</div>

							<div class="form-group">
								<label>AppSecret</label>
								<input type="text" placeholder="应用密钥" value="{$configs['wx_appSecret']}" name="wx_appSecret" class="form-control">
							</div>

							<div class="form-group">
								<label>微支付商户号</label>
								<input type="text" placeholder="商户号" value="{$configs['wx_mchId']}" name="wx_mchId" class="form-control">
							</div>
							<div class="form-group">
								<label>API密钥</label>
								<input type="text" placeholder="Api密钥" value="{$configs['wx_apiSecret']}" name="wx_apiSecret" class="form-control">
							</div>
							<div class="form-group uploade">
								<label>apiclient_cert私钥文件</label>
								<input type="text" placeholder="apiclient_cert私钥文件" <if condition=" $configs['wx_apiclientCert']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if> class="form-control" >
								<input type="hidden" placeholder="apiclient_cert私钥文件" value="{$configs['wx_apiclientCert']|urldecode}" name="wx_apiclientCert" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>
							<div class="form-group uploade">
								<label>apiclient_key公钥文件</label>
								<input type="text" placeholder="apiclient_key公钥文件" <if condition=" $configs['wx_apiclientKey']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if> class="form-control">
								<input type="hidden" placeholder="apiclient_key公钥文件" value="{$configs['wx_apiclientKey']|urldecode}" name="wx_apiclientKey" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>
								<div class="form-group uploade">
								<label>CA证书文件</label>
								<input type="text" placeholder="微信支付rootca文件" <if condition=" $configs['wx_apiclientCa']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if>  class="form-control">
								<input type="hidden" placeholder="微信支付rootca文件" value="{$configs['wx_apiclientCa']|urldecode}" name="wx_apiclientCa" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>

						</div>
					</div>
				</div>
				<div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary btn-confirm">确定</button>
                </div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal inmodal" tabindex="-1" role="dialog" aria-hidden="true" id="weixinSetting2">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInRight">
				<form action="" method="post" enctype="multipart/form-data">
				<div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">微信支付 充值和代收配置</h4>
                </div>
				<div class="modal-body">
					<div class="setting_rows">
						<div id="new_wxpay_box" class="wxpay_box">
							
							<div class="form-group">
								<label>Appid</label>
								<input type="text" placeholder="Appid" value="{$configs['ds_wx_appId']}" name="ds_wx_appId" class="form-control">
							</div>

							<div class="form-group">
								<label>AppSecret</label>
								<input type="text" placeholder="应用密钥" value="{$configs['ds_wx_appSecret']}" name="ds_wx_appSecret" class="form-control">
							</div>

							<div class="form-group">
								<label>微支付商户号</label>
								<input type="text" placeholder="商户号" value="{$configs['ds_wx_mchId']}" name="ds_wx_mchId" class="form-control">
							</div>
							<div class="form-group">
								<label>API密钥</label>
								<input type="text" placeholder="Api密钥" value="{$configs['ds_wx_apiSecret']}" name="ds_wx_apiSecret" class="form-control">
							</div>
							<div class="form-group uploade">
								<label>apiclient_cert私钥文件</label>
								<input type="text" placeholder="apiclient_cert私钥文件" <if condition=" $configs['ds_wx_apiclientCert']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if> class="form-control" >
								<input type="hidden" placeholder="apiclient_cert私钥文件" value="{$configs['ds_wx_apiclientCert']|urldecode}" name="ds_wx_apiclientCert" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>
							<div class="form-group uploade">
								<label>apiclient_key公钥文件</label>
								<input type="text" placeholder="apiclient_key公钥文件" <if condition=" $configs['ds_wx_apiclientKey']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if> class="form-control">
								<input type="hidden" placeholder="apiclient_key公钥文件" value="{$configs['ds_wx_apiclientKey']|urldecode}" name="ds_wx_apiclientKey" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>
								<div class="form-group uploade">
								<label>CA证书文件</label>
								<input type="text" placeholder="微信支付rootca文件" <if condition=" $configs['ds_wx_apiclientCa']  neq '' "> value="pem文件已上传" readonly="readonly" <else /> value="" </if>  class="form-control">
								<input type="hidden" placeholder="微信支付rootca文件" value="{$configs['ds_wx_apiclientCa']|urldecode}" name="ds_wx_apiclientCa" class="hiddeninput">
								<div class="dropz" style="height: 34px;line-height: 34px;border: 1px solid #e5e6e7;width: 70px;text-align: center;position: relative;top: -34px;float: right;cursor: pointer;">文件上传</div>
							</div>

						</div>
					</div>
				</div>
				<div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary btn-confirm">确定</button>
                </div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal inmodal" tabindex="-1" role="dialog" aria-hidden="true" id="gdSetting">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInRight">
				<form action="" method="post" enctype="multipart/form-data">
				<div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">银行渠道配置</h4>
                </div>
				<div class="modal-body">
					<div class="setting_rows">
						<div id="new_wxpay_box" class="wxpay_box">
							<div class="form-group">
								<label>Appid</label>
								<input type="text" placeholder="Appid" value="{$configs['gd_appId']}" name="gd_appId" class="form-control">
							</div>
							<div class="form-group">
								<label>AppSecret</label>
								<input type="text" placeholder="应用密钥" value="{$configs['gd_appSecret']}" name="gd_appSecret" class="form-control">
							</div>
							<div class="form-group">
								<label>渠道号</label>
								<input type="text" placeholder="渠道号" value="{$configs['gd_mchId']}" name="gd_mchId" class="form-control">
							</div>
							<div class="form-group">
								<label>大商户号</label>
								<input type="text" placeholder="大商户号" value="{$configs['gd_parentMid']}" name="gd_parentMid" class="form-control">
							</div>
							<div class="form-group">
								<label>渠道密钥</label>
								<input type="text" placeholder="渠道密钥" value="{$configs['gd_key']}" name="gd_key" class="form-control">
							</div>
					</div>
				</div>
				<div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary btn-confirm">确定</button>
                </div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal inmodal" tabindex="-1"  id="wxApi_Setting">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInRight">
				<div class="modal-header">
                    <button type="button" class="close _close"><span>×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">微信服务器配置接口信息</h4>
                </div>
				<div class="modal-body">
					<div class="setting_rows">
						<div id="wxActionBox" class="wxpay_box">
							<div class="form-group">
								<label>URL：</label>
								<input type="text" placeholder="服务器推送事件地址" value="{pg:$SiteUrl}/merchants.php?m=Index&c=wxAction&a=index&mymid={pg:$_mid}&midtype=1" class="form-control" readonly="readonly">
							</div>
							<div class="form-group">
								<label>Token：</label>
								<input type="text" placeholder="Token令牌" value="" class="form-control wxtoken" readonly="readonly">
							</div>
							<div class="form-group">
								<label>EncodingAESKey：</label>
								<input type="text" placeholder="消息加解密密钥" value="" class="form-control aeskey" readonly="readonly">
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
                    <button type="button" class="btn btn-primary _close">关闭</button>
                </div>
			</div>
		</div>
	</div>

	<div class="modal inmodal" tabindex="-1" role="dialog" aria-hidden="true" id="alipaySetting">
		<div class="modal-dialog">
			<div class="modal-content animated bounceInRight">
				<form action="" method="post" enctype="multipart/form-data">
				<div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">支付宝支付 支付配置</h4>
                </div>
				<div class="modal-body">
					<div class="setting_rows">
						<div id="new_wxpay_box" class="wxpay_box">
							
							<div class="form-group">
								<label>Appid</label>
								<input type="text" placeholder="支付宝Appid(必填)" value="{pg:$payConfig.alipay.appid}" name="alipay[appid]" class="form-control">
							</div>
							<div class="form-group">
								<label>PID</label>
								<input type="text" placeholder="合作者身份Partner id(必填)" value="{pg:$payConfig.alipay.pid}" name="alipay[pid]" class="form-control">
							</div>
							<div class="form-group">
								<label>Key</label>
								<input type="text" placeholder="Key(选填)" value="{pg:$payConfig.alipay.key}" name="alipay[key]" class="form-control">
							</div>
							<div class="form-group">
								<label>卖家账号</label>
								<input type="text" placeholder="卖家账号(选填)" value="{pg:$payConfig.alipay.name}" name="alipay[name]" class="form-control">
							</div>
						  <div class="form-group">
							<label>公钥（服务窗）&nbsp;&nbsp;&nbsp;复制这个公钥到支付宝需要上传的地方</label>
							<input type="text" placeholder="公钥（服务窗）" value="{pg:$rsapublickey}" class="form-control">
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary btn-confirm">确定</button>
                </div>
				</form>
			</div>
		</div>
	</div>



	
    <script>
	 var apihtml="<button class='btn btn-info api' type='button' {pg:if ($payConfig.alipay.isOpen eq 1)} checked='checked' {pg:/if} id='wxApiSetting'> API接口 </button>";
	 if(mobilecheck()){
	     $('#wxapiinfo1').append(apihtml);
		 $('#wxapiinfo1 .api').css('margin-top','15px');
		 $('#new_wxpay_box .uploade').css('display','none');
		 $('#new_wxpay_box').append('<div class="form-group noticee"><label>apiclient_cert私钥文件，apiclient_key公钥文件，CA证书文件等配置请登陆PC端修改</label></div>');
	 }else{
		 $('#new_wxpay_box .uploade').css('display','block');
		 $('#new_wxpay_box .noticee').remove();
	     $('#wxapiinfo2').html(apihtml);
	 }
        $(document).ready(function(){
            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
			/*$('.switch').change(function(){
				if($(this).val() == 1){
					$('.ibox-content').hasClass('hide') && ($('.ibox-content').removeClass('hide')),$('.ibox-content').show();
				}else if($(this).val() == 0){
					$('.ibox-content').hide();
				}
				$.post('?m=System&c=pay&a=field',{isOpen:$(this).val()});
			});*/
			$('.btn-confirm').click(function(){
				var payConfigData = $(this).parents('form').serialize();
				$.post('{:U("SX/Index/savePayinfo")}',{data:htmlToArray(payConfigData)},function(result){
					if(result.status == 1){
						swal({title: "温馨提示",text:'修改成功',type: "success"}, function () {
        					window.location.reload();
   						});
					}else{
						swal({title: "温馨提示",text:'修改失败！',type: "error"});
					}
				},'json');
			});
			/*$('.isOpen').on('ifChanged', function(){
				if($(this).is(':checked')){
					var isOpen = 1;
				}else{
					var isOpen = 0;
				}
				var payConfigData = {};
				typeof(payConfigData[$(this).attr('data-type')]) == 'undefined' && (payConfigData[$(this).attr('data-type')] = {}),payConfigData[$(this).attr('data-type')].isOpen = isOpen;
				$.post('?m=System&c=pay&a=config',{data:payConfigData});
			});*/
			$(".dropz").dropzone({
				url: "{:U('SX/Index/pem_Upload')}",
				addRemoveLinks: false,
				maxFilesize: 1,
				acceptedFiles: ".pem",
				uploadMultiple: false,
				init: function() {
					this.on("success", function(file,responseText) {
						if(responseText.status == 1){
							/***这里的this.element 是 $(".dropz")****/
							$(this.element).siblings('.form-control').val('pem文件已上传');
							$(this.element).siblings('.form-control').attr('readonly','readonly');
							$(this.element).siblings('.hiddeninput').val(responseText.savepath);
						}else{
							swal({title: "温馨提示",text:responseText.error,type: "error"});
						}
					});
				}
			});
        });
		function htmlToArray(data){
			data = data.split('&');
			var info = {};
			$.each(data,function(k,v){
				v = v.replace('%5D','').split('=');
				var s = v[0].split('%5B');
				typeof(info[s[0]]) == 'undefined' && (info[s[0]] = {}),info[s[0]] = v[1];
			});
			return info;
		}

		 $("#wxApiSetting").click(function(){
			$.post('/merchants.php?m=System&c=pay&a=getApiData',function(ret){
			    $('#wxApi_Setting .wxtoken').val(ret.wxtoken);
				$('#wxApi_Setting .aeskey').val(ret.aeskey);
				
				var winW=$(window).width();
				if(winW<750){
				   $('#wxApi_Setting .modal-dialog').css('width','92%');
				}else{
				   $('#wxApi_Setting .modal-dialog').width(730);
				}
				$('body').append('<div class="modal-backdrop in"></div>');
				$('#wxApi_Setting').show();
			},'JSON');
		  });
		  $("#wxApi_Setting ._close").click(function(){
			  $('#wxApi_Setting').hide();
			  $('#wxApi_Setting .wxtoken').val('');
			  $('#wxApi_Setting .aeskey').val('');
			  $('.modal-backdrop').remove();
		  });
    </script>
</block>

